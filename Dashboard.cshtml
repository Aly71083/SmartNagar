@model SmartNagar.ViewModels.AdminDashboardVM
@{
    Layout = null;

    var notifCount = Model?.RecentActivities?.Count(a => a.IsRead == false) ?? 0;
    var adminName = User?.Identity?.Name ?? "Admin";
}

<!DOCTYPE html>
<html>
<head>
    <meta charset="utf-8" />
    <title>Admin Dashboard</title>
    <meta name="viewport" content="width=device-width, initial-scale=1" />

    <style>
        * {
            box-sizing: border-box;
        }

        body {
            margin: 0;
            font-family: "Segoe UI", system-ui, Arial;
            background: #f4f6fb;
            color: #0f172a;
        }

        /* layout */
        .layout {
            display: flex;
            min-height: 100vh;
        }

        .side {
            width: 270px;
            background: linear-gradient(180deg,#6b7cff,#6e4bb6);
            color: #fff;
            padding: 18px 16px;
            display: flex;
            flex-direction: column;
            gap: 14px;
        }

        .brand {
            display: flex;
            align-items: center;
            gap: 12px;
            font-weight: 950;
            font-size: 18px;
            padding: 8px 10px;
        }

            .brand .logo {
                width: 38px;
                height: 38px;
                border-radius: 12px;
                background: rgba(255,255,255,.18);
                display: flex;
                align-items: center;
                justify-content: center;
                font-size: 18px;
            }

        .muted {
            font-size: 12px;
            opacity: .85;
            font-weight: 600;
            margin-top: 2px;
        }

        .menu {
            display: flex;
            flex-direction: column;
            gap: 10px;
            padding-top: 6px;
        }

        .mitem {
            display: flex;
            align-items: center;
            gap: 12px;
            padding: 12px 12px;
            border-radius: 14px;
            color: #fff;
            text-decoration: none;
            font-weight: 850;
            opacity: .95;
        }

            .mitem:hover {
                background: rgba(255,255,255,.12);
            }

            .mitem.active {
                background: rgba(255,255,255,.18);
            }

        .sideFooter {
            margin-top: auto;
            background: rgba(255,255,255,.14);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 18px;
            padding: 12px;
            display: flex;
            flex-direction: column;
            gap: 10px;
        }

        .userCard {
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .avatar {
            width: 40px;
            height: 40px;
            border-radius: 14px;
            background: rgba(255,255,255,.22);
            display: flex;
            align-items: center;
            justify-content: center;
            font-weight: 950;
        }

        .logoutBtn {
            width: 100%;
            border: none;
            padding: 10px 12px;
            border-radius: 14px;
            background: rgba(255,255,255,.18);
            color: #fff;
            font-weight: 950;
            cursor: pointer;
        }

            .logoutBtn:hover {
                background: rgba(255,255,255,.24);
            }

        /* main */
        .main {
            flex: 1;
            padding: 18px 20px;
        }

        .topbar {
            display: flex;
            align-items: center;
            justify-content: space-between;
            background: #fff;
            border: 1px solid #eef2f7;
            border-radius: 18px;
            padding: 14px 16px;
            box-shadow: 0 10px 24px rgba(15,23,42,.06);
        }

        .title h1 {
            margin: 0;
            font-size: 22px;
            font-weight: 950;
        }

        .title p {
            margin: 4px 0 0;
            color: #64748b;
            font-weight: 650;
            font-size: 13px;
        }

        .topActions {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .search {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 10px 12px;
            border: 1px solid #e7edf6;
            border-radius: 14px;
            background: #fbfdff;
            min-width: 340px;
        }

            .search input {
                border: none;
                outline: none;
                width: 100%;
                background: transparent;
                font-weight: 700;
            }

        .iconBtn {
            width: 42px;
            height: 42px;
            border-radius: 14px;
            border: 1px solid #eef2f7;
            background: #fff;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }

            .iconBtn:hover {
                background: #f6f8ff;
            }

        .badge {
            position: absolute;
            top: -6px;
            right: -6px;
            background: #ef4444;
            color: #fff;
            border-radius: 999px;
            font-weight: 950;
            font-size: 12px;
            padding: 2px 7px;
            border: 2px solid #fff;
        }

        /* quick actions */
        .quick {
            margin-top: 14px;
            background: linear-gradient(90deg,#6b7cff,#6e4bb6);
            color: #fff;
            border-radius: 18px;
            padding: 14px;
            box-shadow: 0 14px 30px rgba(99,102,241,.18);
        }

        .quickRow {
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 12px;
            margin-top: 10px;
        }

        .qbtn {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 12px 14px;
            background: rgba(255,255,255,.14);
            border: 1px solid rgba(255,255,255,.14);
            border-radius: 14px;
            color: #fff;
            text-decoration: none;
            font-weight: 900;
        }

            .qbtn:hover {
                background: rgba(255,255,255,.20);
            }

        /* stat cards */
        .stats {
            margin-top: 14px;
            display: grid;
            grid-template-columns: repeat(4, 1fr);
            gap: 14px;
        }

        .card {
            background: #fff;
            border: 1px solid #eef2f7;
            border-radius: 18px;
            padding: 16px;
            box-shadow: 0 10px 24px rgba(15,23,42,.06);
            position: relative;
            overflow: hidden;
            min-height: 120px;
        }

            .card:before {
                content: '';
                position: absolute;
                left: 0;
                top: 0;
                bottom: 0;
                width: 5px;
                background: #6366f1;
            }

            .card .k {
                color: #64748b;
                font-weight: 800;
                font-size: 12px;
            }

            .card .v {
                font-size: 30px;
                font-weight: 980;
                margin-top: 8px;
            }

        .mini {
            margin-top: 6px;
            color: #94a3b8;
            font-weight: 700;
            font-size: 12px;
        }

        .c2:before {
            background: #0ea5e9;
        }

        .c3:before {
            background: #22c55e;
        }

        .c4:before {
            background: #ef4444;
        }

        /* recent activity */
        .grid {
            margin-top: 14px;
            display: grid;
            grid-template-columns: 1.3fr 1fr;
            gap: 14px;
        }

        .panel {
            background: #fff;
            border: 1px solid #eef2f7;
            border-radius: 18px;
            box-shadow: 0 10px 24px rgba(15,23,42,.06);
            overflow: hidden;
        }

            .panel .ph {
                padding: 14px 16px;
                border-bottom: 1px solid #eef2f7;
                display: flex;
                align-items: center;
                justify-content: space-between;
            }

                .panel .ph h2 {
                    margin: 0;
                    font-size: 16px;
                    font-weight: 950;
                }

                .panel .ph .smallLink {
                    color: #2563eb;
                    font-weight: 900;
                    text-decoration: none;
                }

                    .panel .ph .smallLink:hover {
                        text-decoration: underline;
                    }

        .activity {
            padding: 14px 16px;
            display: flex;
            flex-direction: column;
            gap: 12px;
        }

        .item {
            border: 1px solid #eef2f7;
            border-radius: 16px;
            padding: 12px;
            background: #fff;
        }

            .item .row {
                display: flex;
                justify-content: space-between;
                gap: 10px;
            }

            .item .t {
                font-weight: 950;
            }

            .item .d {
                color: #64748b;
                font-weight: 700;
                font-size: 13px;
                margin-top: 4px;
            }

            .item .time {
                color: #94a3b8;
                font-weight: 800;
                font-size: 12px;
                white-space: nowrap;
            }

        .hint {
            padding: 12px;
            color: #64748b;
            font-weight: 800;
        }

        /* responsive */
        @@media (max-width: 1100px) {
            .stats {
                grid-template-columns: repeat(2, 1fr);
            }

            .quickRow {
                grid-template-columns: repeat(2, 1fr);
            }

            .grid {
                grid-template-columns: 1fr;
            }

            .search {
                min-width: 220px;
            }
        }

        @@media (max-width: 820px) {
            .side {
                display: none;
            }

            .search {
                display: none;
            }
        }
    </style>
</head>

<body>
    <div class="layout">

        <!-- Sidebar -->
        <aside class="side">
            <div class="brand">
                <div class="logo">🏛️</div>
                <div>
                    Smart Nagar
                    <div class="muted">Municipal System</div>
                </div>
            </div>

            <nav class="menu">
                <a class="mitem active" href="/Admin/Dashboard">🏠 Dashboard</a>
                <a class="mitem" href="/Admin/ManageUsers">👥 Manage Users</a>
                <a class="mitem" href="/Admin/SystemOverview">📊 System Overview</a>
                <a class="mitem" href="/Admin/PublishNotice">📣 Publish Notice</a>
                <a class="mitem" href="/Admin/Notices">🗂️ Notices</a>
            </nav>

            <div class="sideFooter">
                <div class="userCard">
                    <div class="avatar">A</div>
                    <div>
                        <div style="font-weight:950;">@adminName</div>
                        <div class="muted">System Admin</div>
                    </div>
                </div>
                <form method="post" action="/Account/Logout">
                    <button class="logoutBtn" type="submit">Logout</button>
                </form>
            </div>
        </aside>

        <!-- Main -->
        <main class="main">

            <div class="topbar">
                <div class="title">
                    <h1>Dashboard Overview</h1>
                    <p>Welcome back! Here’s what’s happening today.</p>
                </div>

                <div class="topActions">
                    <div class="search">
                        🔎 <input id="searchBox" type="text" placeholder="Search recent activity / notices..." />
                    </div>

                    <button class="iconBtn" title="Notifications" type="button" onclick="toggleNotif(true)">
                        🔔
                        @if (notifCount > 0)
                        {
                            <span class="badge" id="notifBadge">@notifCount</span>
                        }
                    </button>

                    <a class="iconBtn" href="/Admin/SystemOverview" title="Analytics">📈</a>
                </div>
            </div>

            <!-- Quick Actions -->
            <section class="quick">
                <div style="font-weight:950;">⚡ Quick Actions</div>
                <div class="quickRow">
                    <a class="qbtn" href="/Admin/PublishNotice">📣 Post Notice</a>
                    <a class="qbtn" href="/Admin/ManageUsers">👥 Manage Users</a>
                    <a class="qbtn" href="/Admin/SystemOverview">📊 View Analytics</a>
                    <a class="qbtn" href="/Admin/GenerateReportPdf">📄 Export PDF Report</a>
                </div>
            </section>

            <!-- Stats -->
            <section class="stats">
                <div class="card c1">
                    <div class="k">TOTAL USERS</div>
                    <div class="v">@Model.TotalUsers</div>
                    <div class="mini">Active citizens + officials</div>
                </div>

                <div class="card c2">
                    <div class="k">TOTAL COMPLAINTS</div>
                    <div class="v">@Model.TotalComplaints</div>
                    <div class="mini">All categories</div>
                </div>

                <div class="card c3">
                    <div class="k">RESOLVED</div>
                    <div class="v">@Model.Resolved</div>
                    <div class="mini">Complaint.Status = Resolved</div>
                </div>

                <div class="card c4">
                    <div class="k">PENDING</div>
                    <div class="v">@Model.Pending</div>
                    <div class="mini">Complaint.Status = Pending</div>
                </div>
            </section>

            <!-- Panels -->
            <section class="grid">

                <div class="panel">
                    <div class="ph">
                        <h2>📌 Recent Activity</h2>
                        <a class="smallLink" href="/Admin/SystemOverview">Open Analytics →</a>
                    </div>

                    <div class="activity" id="activityList">
                        @if (Model.RecentActivities == null || Model.RecentActivities.Count == 0)
                        {
                            <div class="hint">No activity yet. Publish a notice or manage users to see activity logs here.</div>
                        }
                        else
                        {
                            foreach (var a in Model.RecentActivities.Take(8))
                            {
                                <div class="item activityItem" data-text="@($"{a.Title} {a.Detail} {a.Type}")">
                                    <div class="row">
                                        <div class="t">@a.Title</div>
                                        <div class="time">@a.CreatedAt.ToLocalTime().ToString("dd MMM, hh:mm tt")</div>
                                    </div>
                                    <div class="d">@a.Detail</div>
                                </div>
                            }
                        }
                    </div>
                </div>

                <div class="panel">
                    <div class="ph">
                        <h2>🧭 Admin Shortcuts</h2>
                        <a class="smallLink" href="/Admin/Notices">View Notices →</a>
                    </div>

                    <div style="padding:14px 16px; display:grid; grid-template-columns:1fr; gap:12px;">
                        <a class="qbtn" style="background:#f1f5ff; color:#1e40af; border-color:#e0e7ff;" href="/Admin/PublishNotice">✅ Publish new announcement</a>
                        <a class="qbtn" style="background:#ecfeff; color:#155e75; border-color:#cffafe;" href="/Admin/ManageUsers">✅ Activate / Deactivate users</a>
                        <a class="qbtn" style="background:#f0fdf4; color:#14532d; border-color:#dcfce7;" href="/Admin/GenerateReportPdf">✅ Download PDF report</a>
                        <a class="qbtn" style="background:#fff7ed; color:#7c2d12; border-color:#ffedd5;" href="/Home/Index">✅ Go to public homepage</a>
                    </div>
                </div>

            </section>

        </main>
    </div>

    <!-- =========================
         NOTIFICATION PANEL
    ========================= -->
    <div id="notifOverlay" style="display:none; position:fixed; inset:0; background:rgba(0,0,0,.25); z-index:9999;">
        <div style="position:absolute; top:80px; right:22px; width:min(420px,92vw);
              background:#fff; border:1px solid #eef2f7; border-radius:18px;
              box-shadow:0 20px 60px rgba(0,0,0,.2); overflow:hidden;">
            <div style="padding:14px 16px; border-bottom:1px solid #eef2f7; display:flex; justify-content:space-between; align-items:center;">
                <div style="font-weight:950;">Notifications</div>
                <div style="display:flex; gap:10px; align-items:center;">
                    <button type="button" onclick="markAllRead()"
                            style="border:none; background:#f1f5ff; color:#1e40af; font-weight:950; padding:8px 10px; border-radius:12px; cursor:pointer;">
                        Mark all read
                    </button>
                    <button type="button" onclick="toggleNotif(false)" style="border:none; background:#fff; font-weight:950; cursor:pointer;">✖</button>
                </div>
            </div>

            <div id="notifList" style="max-height:420px; overflow:auto; padding:12px; display:flex; flex-direction:column; gap:10px;">
                @if (Model.RecentActivities == null || Model.RecentActivities.Count == 0)
                {
                    <div style="padding:12px; border:1px solid #eef2f7; border-radius:14px; color:#64748b; font-weight:700;">
                        No notifications yet.
                    </div>
                }
                else
                {
                    foreach (var n in Model.RecentActivities.Take(12))
                    {
                        var bg = n.IsRead ? "#ffffff" : "#fbfdff";
                        var border = n.IsRead ? "#eef2f7" : "#c7d2fe";

                        <div class="notifItem"
                             data-title="@($"{n.Title} {n.Detail}")"
                             data-id="@n.Id"
                             data-read="@n.IsRead"
                             style="padding:12px; border:1px solid @border; background:@bg; border-radius:14px; cursor:pointer;"
                             onclick="markRead(@n.Id, this)">
                            <div style="display:flex; justify-content:space-between; gap:10px;">
                                <div style="font-weight:950;">@n.Title</div>
                                <div style="color:#94a3b8; font-weight:750; font-size:12px; white-space:nowrap;">
                                    @n.CreatedAt.ToLocalTime().ToString("dd MMM, hh:mm tt")
                                </div>
                            </div>
                            <div style="color:#64748b; font-weight:650; font-size:13px; margin-top:4px;">@n.Detail</div>
                        </div>
                    }
                }
            </div>
        </div>
    </div>

    <script>
        // SEARCH (filters recent activity + notifications)
        const searchBox = document.getElementById('searchBox');
        if (searchBox) {
            searchBox.addEventListener('input', () => {
                const q = (searchBox.value || '').toLowerCase().trim();

                document.querySelectorAll('.activityItem').forEach(el => {
                    const t = (el.getAttribute('data-text') || '').toLowerCase();
                    el.style.display = t.includes(q) ? '' : 'none';
                });

                document.querySelectorAll('#notifList .notifItem').forEach(el => {
                    const t = (el.getAttribute('data-title') || '').toLowerCase();
                    el.style.display = t.includes(q) ? '' : 'none';
                });
            });
        }

        function toggleNotif(show) {
            document.getElementById('notifOverlay').style.display = show ? 'block' : 'none';
        }

        document.getElementById('notifOverlay').addEventListener('click', (e) => {
            if (e.target.id === 'notifOverlay') toggleNotif(false);
        });

        async function markRead(id, el) {
            try {
                await fetch('/Admin/MarkActivityRead', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                    body: 'id=' + encodeURIComponent(id)
                });

                // UI mark read
                if (el) {
                    el.style.background = '#ffffff';
                    el.style.borderColor = '#eef2f7';
                    el.setAttribute('data-read', 'True');
                }

                // Reduce badge
                const badge = document.getElementById('notifBadge');
                if (badge) {
                    let n = parseInt(badge.innerText || '0');
                    n = Math.max(0, n - 1);
                    if (n === 0) badge.remove();
                    else badge.innerText = n;
                }
            } catch { }
        }

        async function markAllRead() {
            try {
                await fetch('/Admin/MarkAllRead', { method: 'POST' });

                document.querySelectorAll('#notifList .notifItem').forEach(el => {
                    el.style.background = '#ffffff';
                    el.style.borderColor = '#eef2f7';
                    el.setAttribute('data-read', 'True');
                });

                const badge = document.getElementById('notifBadge');
                if (badge) badge.remove();
            } catch { }
        }
    </script>

</body>
</html>
